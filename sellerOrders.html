<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Delight PK - Seller Orders</title>
<style>
body { margin:0; font-family:'Poppins',sans-serif; background:#f8f8f8; padding-bottom:50px; }

/* Header */
header {
  position:fixed; top:0; left:0; width:100%;
  background:linear-gradient(135deg,#ff6a00,#ff3d00);
  display:flex; align-items:center; justify-content:center;
  height:65px;
  box-shadow:0 3px 10px rgba(0,0,0,0.15);
  border-bottom-left-radius:35px; border-bottom-right-radius:35px;
  z-index:10;
}
.back-btn {
  position:absolute; left:18px; top:50%; transform:translateY(-50%);
  background:rgba(255,255,255,0.9); border-radius:50%; width:38px; height:38px;
  display:flex; align-items:center; justify-content:center; box-shadow:0 2px 6px rgba(0,0,0,0.2);
  cursor:pointer;
}
.back-btn img { width:22px; height:22px; }
header h4 { color:#fff; font-size:21px; font-weight:600; text-shadow:0 1px 3px rgba(0,0,0,0.25); }

/* Filter Bar */
.filter-bar { margin-top:70px; display:flex; overflow-x:auto; gap:10px; padding:10px; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); scrollbar-width:none; }
.filter-bar::-webkit-scrollbar { display:none; }
.filter-bar button { flex:0 0 auto; padding:8px 16px; border:none; border-radius:25px; background:#e0e0e0; font-weight:600; cursor:pointer; transition:0.3s; }
.filter-bar button.active { background:#ff6a00; color:#fff; }

/* Orders */
.container { padding:15px; margin-top:10px; }
.order-card { position:relative; background:#fff; padding:15px; margin-bottom:20px; border-radius:12px; box-shadow:0 3px 8px rgba(0,0,0,0.1); border-left:5px solid #ff6a00; transition:0.2s ease; }
.order-card p { margin:6px 0; font-size:14px; }
.product-box { display:flex; align-items:center; gap:12px; background:#fafafa; padding:10px; border-radius:10px; margin-top:10px; border:1px solid #ddd; cursor:pointer; transition:0.2s ease; }
.product-box img { width:70px; height:70px; object-fit:cover; border-radius:8px; border:1px solid #ccc; }
.buyer-info { margin-bottom:10px; padding-bottom:5px; border-bottom:1px solid #ddd; }

/* Status buttons & badges */
.status-btns { display:flex; justify-content:space-between; margin-top:12px; gap:8px; flex-wrap:wrap; }
.status-btns button { flex:1; padding:10px; border:none; border-radius:8px; font-weight:bold; color:#fff; cursor:pointer; font-size:13px; transition:0.2s; }
.status-pending { background:#f0ad4e; }
.status-shipped { background:#5bc0de; }
.status-delivered { background:#5cb85c; }
.status-cancelled { background:#d9534f; }
.status-btns button.selected { box-shadow:0 0 0 3px rgba(0,0,0,0.15); pointer-events:none; opacity:0.7; }
.status-btns button:hover { transform:scale(1.05); }

/* Delivered/Cancelled badge top-right */
.status-badge {
  position: absolute;
  top:10px;
  right:15px;
  padding:5px 10px;
  border-radius:8px;
  font-size:12px;
  font-weight:bold;
  color:white;
}

/* Address Box */
.address-box { background:#fff7ef; padding:10px 12px; border-left:4px solid #ff6a00; border-radius:8px; margin-top:10px; font-size:13.5px; color:#333; line-height:1.5; }
.address-box strong { color:#ff6a00; }
.address-box .heading { text-align:center; font-weight:600; font-size:14px; color:black; margin-bottom:5px; }

/* Loading */
#loading { text-align:center; margin-top:40px; color:#555; }
</style>
</head>
<body>

<header>
  <div class="back-btn" onclick="history.back()"><img src="Delight icons/back.png" alt="Back"></div>
  <h4>Seller Orders</h4>
</header>

<div class="filter-bar" id="filterBar"></div>
<div class="container" id="orderList">
  <div id="loading">Loading orders...</div>
</div>

<script>
const seller = JSON.parse(localStorage.getItem("seller"));
if(!seller){ alert("Please login first!"); window.location.href="login.html"; }

const statuses = ["Pending","Shipped","Delivered","Cancelled"];
let currentFilter = "Pending";

const filterBar = document.getElementById("filterBar");
statuses.forEach(status => {
  const btn = document.createElement("button");
  btn.innerText = status;
  if(status === currentFilter) btn.classList.add("active");
  btn.onclick = () => { currentFilter = status; updateFilterButtons(); loadOrders(); };
  filterBar.appendChild(btn);
});

function updateFilterButtons(){
  Array.from(filterBar.children).forEach(btn=>{
    btn.classList.remove("active");
    if(btn.innerText === currentFilter) btn.classList.add("active");
  });
}

async function loadOrders(){
  const container = document.getElementById("orderList");
  container.innerHTML = "<div id='loading'>Loading...</div>";
  try{
    const res = await fetch(`https://5238f098-6b7a-4815-b792-a10ea88e4c13-00-54fclrw8sb5.pike.replit.dev/seller-orders/${seller.phone}`);
    let orders = await res.json();
    if(!orders || orders.length===0){ container.innerHTML="<p style='text-align:center;'>No orders found.</p>"; return; }

    // **Sort by most recent first**
    orders.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));

    let filteredOrders = orders.filter(o => o.status === currentFilter);
    container.innerHTML = "";
    filteredOrders.forEach(order => {
      const div = document.createElement("div"); div.className = "order-card";
      const product = order.product || {};
      const imgUrl = product.image || (product.images?.[0] || "no-img.jpg");

      const buyerDiv = document.createElement("div"); buyerDiv.className = "buyer-info";
      buyerDiv.innerHTML = `<p><strong>Buyer:</strong> ${order.buyerName || "N/A"}</p>
                            <p><strong>Phone:</strong> ${order.buyerPhone || "N/A"}</p>`;
      div.appendChild(buyerDiv);

      const productBox = document.createElement("div"); productBox.className = "product-box";
      productBox.innerHTML = `<img src="${imgUrl}" alt="Product">
                              <div><p><strong>${product.title || "Unknown Product"}</strong></p>
                              <p>Price: Rs ${product.price || "N/A"}</p></div>`;
      productBox.onclick = ()=>{ localStorage.setItem("selectedItem",JSON.stringify(product)); window.location.href="itemDetails.html"; };
      div.appendChild(productBox);

      if(order.address){
        const parts = order.address.split(',').map(p=>p.trim());
        let addrHTML = `<div class="heading">Address Details</div>`;
        if(parts[0]) addrHTML += `<div>Province: <strong>${parts[0]}</strong></div>`;
        if(parts[1]) addrHTML += `<div>City: <strong>${parts[1]}</strong></div>`;
        if(parts[2]) addrHTML += `<div>Zone/Area: <strong>${parts[2]}</strong></div>`;
        if(parts[3]) addrHTML += `<div>Full Address: <strong>${parts.slice(3).join(', ')}</strong></div>`;
        const addrDiv = document.createElement("div"); addrDiv.className = "address-box"; addrDiv.innerHTML = addrHTML;
        div.appendChild(addrDiv);
      }

      if(order.status === "Pending" || order.status === "Shipped"){
          const statusDiv = document.createElement("div"); 
          statusDiv.className = "status-btns";
          ["Pending","Shipped","Delivered","Cancelled"].forEach(s=>{
              const btn = document.createElement("button");
              btn.className = `status-${s.toLowerCase()}`;
              btn.innerText = s;
              if(order.status === s) btn.classList.add("selected");

              btn.onclick = async ()=>{
                  if(order.status !== s){
                      try{
                          const res = await fetch(`https://5238f098-6b7a-4815-b792-a10ea88e4c13-00-54fclrw8sb5.pike.replit.dev/update-order/${order.id}`,{
                              method:"PUT",
                              headers:{"Content-Type":"application/json"},
                              body:JSON.stringify({status:s})
                          });
                          const data = await res.json();
                          if(data.success){
                              order.status = s;
                              Array.from(statusDiv.children).forEach(b=>b.classList.remove("selected"));
                              btn.classList.add("selected");
                          } else alert("Failed to update status!");
                      }catch(err){ console.error(err); alert("Server error!"); }
                  }
              };
              statusDiv.appendChild(btn);
          });
          div.appendChild(statusDiv);
      } else {
          const badge = document.createElement("div");
          badge.className = `status-badge status-${order.status.toLowerCase()}`;
          badge.innerText = order.status;
          div.appendChild(badge);
      }

      container.appendChild(div);
    });
  }catch(err){ console.error(err); container.innerHTML="<p style='text-align:center;color:red;'>Error loading orders.</p>"; }
}

window.onload = loadOrders;
</script>

</body>
</html>