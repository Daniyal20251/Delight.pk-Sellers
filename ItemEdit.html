<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edit Product - Delight.pk</title>

<style>
body{
  font-family:'Segoe UI',sans-serif;
  background:#f9f9f9;
  padding:20px;
  max-width:600px;
  margin:auto;
}
h3{
  color:#ef6c00;
  border-bottom:2px solid #ef6c00;
  padding-bottom:5px;
}
label{
  font-weight:bold;
  display:block;
  margin-top:15px;
}
input[type="text"], textarea{
  width:100%;
  padding:8px;
  border:1px solid #ccc;
  border-radius:8px;
  margin-top:5px;
}
input[readonly]{
  background:#fff8e6;
  cursor:pointer;
}
.fileUpload{
  position:relative;
  display:inline-block;
  overflow:hidden;
  background:#ef6c00;
  color:white;
  border-radius:8px;
  padding:8px 14px;
  cursor:pointer;
  font-size:14px;
  margin-top:10px;
  margin-right:10px;
}
.fileUpload input{
  position:absolute;
  inset:0;
  opacity:0;
  cursor:pointer;
}
button{
  background:#ef6c00;
  color:white;
  border:none;
  padding:10px 18px;
  border-radius:8px;
  cursor:pointer;
  margin-top:20px;
  font-weight:bold;
}
.preview-container{
  display:flex;
  flex-wrap:wrap;
  margin-top:10px;
}
.preview-container img,
.preview-container video{
  width:80px;
  height:80px;
  object-fit:cover;
  margin:5px;
  border-radius:8px;
  border:1px solid #ddd;
}
.success{
  background:#e8f5e9;
  border:1px solid #4caf50;
  color:#2e7d32;
  padding:10px;
  border-radius:8px;
  display:none;
  margin-top:15px;
}
</style>
</head>

<body>

<h3>Edit Product</h3>

<form id="productForm">

<label>Title</label>
<input type="text" id="title">

<label>Price</label>
<input type="text" id="price">

<label>Discount (Rs.)</label>
<input type="text" id="discount">

<label>Colors</label>
<input type="text" id="colors">

<label>Sizes</label>
<input type="text" id="sizes">

<label>Description</label>
<textarea id="description" rows="5"></textarea>

<label>Category</label>
<input type="text" id="selectedCategoryInput" readonly placeholder="Choose Category">

<label>Product Images (12 max)</label>
<div id="imageInputs"></div>
<div class="preview-container" id="imagePreview"></div>

<label>Product Videos (3 max)</label>
<div id="videoInputs"></div>
<div class="preview-container" id="videoPreview"></div>

<button type="submit">Update Product</button>
</form>

<div id="successBox" class="success">‚úÖ Product updated successfully!</div>

<script>
// üîê Seller check
const seller = JSON.parse(localStorage.getItem("seller"));
if(!seller){
  alert("Please login first");
  location.href="login.html";
}
const sellerPhone = seller.phone;

// üì¶ Load product to edit
const editItem = JSON.parse(localStorage.getItem("editItem") || "{}");
if(!editItem.id){
  alert("No product selected");
  location.href="seller-products.html";
}

// Fill data
title.value = editItem.title || "";
price.value = editItem.price || "";
discount.value = editItem.discount || "";
colors.value = editItem.colors || "";
sizes.value = editItem.sizes || "";
description.value = editItem.description || "";
selectedCategoryInput.value = editItem.category || "";

// Category picker
selectedCategoryInput.onclick = () => {
  window.open("SelectCategory.html","_blank","width=400,height=600");
};

// Sync category after popup
window.addEventListener("focus",()=>{
  const cat = localStorage.getItem("selectedCategory");
  if(cat) selectedCategoryInput.value = cat;
});

// üñºÔ∏è Images
for(let i=0;i<12;i++){
  const lbl=document.createElement("label");
  lbl.className="fileUpload";
  lbl.innerHTML=`Upload Image ${i+1}<input type="file" class="imgInput" accept="image/*">`;
  imageInputs.appendChild(lbl);
}
(editItem.images||[]).forEach(src=>{
  const img=document.createElement("img");
  img.src=src;
  imagePreview.appendChild(img);
});
document.addEventListener("change",e=>{
  if(e.target.classList.contains("imgInput")){
    const f=e.target.files[0];
    if(f){
      const img=document.createElement("img");
      img.src=URL.createObjectURL(f);
      imagePreview.appendChild(img);
    }
  }
});

// üé• Videos
for(let i=0;i<3;i++){
  const lbl=document.createElement("label");
  lbl.className="fileUpload";
  lbl.innerHTML=`Upload Video ${i+1}<input type="file" class="videoInput" accept="video/*">`;
  videoInputs.appendChild(lbl);
}
(editItem.videos||[]).forEach(src=>{
  const v=document.createElement("video");
  v.src=src;
  v.controls=true;
  videoPreview.appendChild(v);
});
document.addEventListener("change",e=>{
  if(e.target.classList.contains("videoInput")){
    const f=e.target.files[0];
    if(f){
      const v=document.createElement("video");
      v.src=URL.createObjectURL(f);
      v.controls=true;
      videoPreview.appendChild(v);
    }
  }
});

// üöÄ Update submit
productForm.onsubmit = async e =>{
  e.preventDefault();

  if(!title.value || !price.value){
    alert("Title & price required");
    return;
  }

  const fd = new FormData();
  fd.append("sellerPhone",sellerPhone);
  fd.append("category",selectedCategoryInput.value);
  fd.append("title",title.value);
  fd.append("price",price.value);
  fd.append("discount",discount.value);
  fd.append("colors",colors.value);
  fd.append("sizes",sizes.value);
  fd.append("description",description.value);

  document.querySelectorAll(".imgInput").forEach(i=>{
    if(i.files[0]) fd.append("images",i.files[0]);
  });
  document.querySelectorAll(".videoInput").forEach(i=>{
    if(i.files[0]) fd.append("videos",i.files[0]);
  });

  try{
    const res = await fetch(
      `https://delight-backend--araindaniyalo2.replit.app/edit-product/${editItem.id}`,
      {method:"PUT",body:fd}
    );
    const data = await res.json();
    if(data.success){
      successBox.style.display="block";
      localStorage.removeItem("editItem");
      localStorage.removeItem("selectedCategory");
    }else{
      alert(data.message||"Update failed");
    }
  }catch{
    alert("Server error");
  }
};
</script>

</body>
</html>