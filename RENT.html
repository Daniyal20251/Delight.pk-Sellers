<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Delight PK - Delivered Orders</title>

<style>
body { margin:0; font-family:'Poppins',sans-serif; background:#f8f8f8; padding-bottom:80px; }

/* Header */
header {
  position:fixed; top:0; left:0; width:100%;
  background:linear-gradient(135deg,#ff6a00,#ff3d00);
  display:flex; align-items:center; justify-content:center;
  height:65px;
  box-shadow:0 3px 10px rgba(0,0,0,0.15);
  border-bottom-left-radius:35px; border-bottom-right-radius:35px;
  z-index:10;
}
.back-btn {
  position:absolute; left:18px; top:50%; transform:translateY(-50%);
  background:rgba(255,255,255,0.9); border-radius:50%; width:38px; height:38px;
  display:flex; align-items:center; justify-content:center; box-shadow:0 2px 6px rgba(0,0,0,0.2);
  cursor:pointer;
}
.back-btn img { width:22px; height:22px; }
header h4 { color:#fff; font-size:21px; font-weight:600; text-shadow:0 1px 3px rgba(0,0,0,0.25); }

/* Filter Buttons */
.filter-bar {
  display:flex; justify-content:center; gap:10px; margin-top:80px; padding:0 15px;
}
.filter-bar button {
  padding:6px 12px; border:none; border-radius:8px; cursor:pointer; color:#fff;
  font-weight:600; transition:0.2s;
}
.filter-pending { background:#f0ad4e; }
.filter-paid { background:#5cb85c; }
.filter-active { box-shadow:0 3px 8px rgba(0,0,0,0.2); transform:scale(1.05); }

/* Container */
.container { padding:15px; margin-top:15px; }

/* Order Card */
.order-card {
  position:relative;
  background:#fff; 
  padding:15px; 
  margin-bottom:20px; 
  border-radius:12px; 
  box-shadow:0 3px 8px rgba(0,0,0,0.1); 
  border-left:5px solid #5cb85c;
}
.order-card p { margin:6px 0; font-size:14px; }

/* Status badge */
.status-badge {
  position: absolute;
  top: 12px;
  right: 12px;
  padding: 6px 12px;
  border-radius: 10px;
  font-size: 12px;
  font-weight: bold;
  color: white;
  z-index: 5;
  max-width: 90px;
  text-align: center;
}
.status-pending { background:#f0ad4e; }
.status-paid { background:#5cb85c; }

/* Product Box */
.product-box {
  display:flex; 
  align-items:center; 
  gap:12px; 
  background:#fafafa; 
  padding:10px; 
  border-radius:10px; 
  margin-top:10px; 
  border:1px solid #ddd; 
}
.product-box img {
  width:70px; height:70px;
  object-fit:cover; 
  border-radius:8px; 
  border:1px solid #ccc;
}

/* Fee box */
.fee-box {
  margin-top:10px;
  background:#fff3f3;
  padding:10px 12px;
  border-radius:10px;
  border-left:4px solid #ff3d00;
  font-size:14px;
  line-height:1.5;
}

/* Bottom Total Bar */
.bottom-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right:0;
  width: 100%;
  max-width:100%;
  background: #ffffff;
  border-top: 2px solid #ddd;
  padding: 12px 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 16px;
  font-weight: 600;
  box-shadow: 0 -3px 10px rgba(0,0,0,0.1);
  box-sizing: border-box;
  z-index: 20;
}
.bottom-bar button {
  background: #ff3d00;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 6px 14px;
  cursor: pointer;
  font-weight: 600;
}

#loading { text-align:center; margin-top:40px; color:#555; word-wrap: break-word; }
</style>
</head>

<body>

<header>
  <div class="back-btn" onclick="history.back()">
    <img src="Delight icons/Back.png">
  </div>
  <h4>Delivered Orders</h4>
</header>

<!-- FILTER BUTTONS -->
<div class="filter-bar">
  <button id="filterPending" class="filter-pending filter-active">Pending</button>
  <button id="filterPaid" class="filter-paid">Paid</button>
</div>

<div class="container" id="orderList">
  <div id="loading">Loading delivered orders...</div>
</div>

<!-- BOTTOM TOTAL BAR -->
<div class="bottom-bar" id="bottomBar">
  <span>Total Fee: <span id="totalFeeValue">Rs 0</span></span>
  <button id="withdrawBtn">Pay</button>
</div>

<script>
const seller = JSON.parse(localStorage.getItem("seller"));
if(!seller){ 
  alert("Please login first!");
  window.location.href="login.html";
}

let deliveredOrders = [];
let currentFilter = "Pending"; // default view

async function loadOrders(){
  const container = document.getElementById("orderList");
  const totalFeeHTML = document.getElementById("totalFeeValue");

  container.innerHTML = "<div id='loading'>Loading...</div>";

  try{
    const res = await fetch(`https://5238f098-6b7a-4815-b792-a10ea88e4c13-00-54fclrw8sb5.pike.replit.dev/seller-orders/${seller.phone}`);
    let orders = await res.json();

    if(!orders || orders.length === 0){
      container.innerHTML = "<p style='text-align:center;'>No delivered orders found.</p>";
      totalFeeHTML.textContent = "Rs 0";
      return;
    }

    deliveredOrders = orders.filter(o => o.status === "Delivered");

    if(deliveredOrders.length === 0){
      container.innerHTML = "<p style='text-align:center;'>No delivered orders found.</p>";
      totalFeeHTML.textContent = "Rs 0";
      return;
    }

    deliveredOrders = deliveredOrders.map(order => ({
      ...order,
      paymentId: order.paymentId || "FEE-" + order.id
    }));

    renderOrders();
  }catch(err){
    console.error(err);
    container.innerHTML = "<p style='text-align:center;color:red;'>Error loading orders.</p>";
    totalFeeHTML.textContent = "Rs 0";
  }
}

function renderOrders(){
  const container = document.getElementById("orderList");
  const totalFeeHTML = document.getElementById("totalFeeValue");
  const bottomBar = document.getElementById("bottomBar");

  let filteredOrders = deliveredOrders;
  if(currentFilter === "Pending") filteredOrders = deliveredOrders.filter(o=>o.paymentStatus!=="Paid");
  if(currentFilter === "Paid") filteredOrders = deliveredOrders.filter(o=>o.paymentStatus==="Paid");

  container.innerHTML = "";
  if(filteredOrders.length === 0){
    container.innerHTML = "<p style='text-align:center;'>No orders found.</p>";
    totalFeeHTML.textContent = "Rs 0";
    bottomBar.style.display = currentFilter==="Paid" ? "none" : "flex";
    return;
  }

  let totalFee = 0;

  filteredOrders.forEach(order=>{
    const div = document.createElement("div");
    div.className = "order-card";

    const product = order.product || {};
    const imgUrl = product.image || (product.images?.[0] || "no-img.jpg");

    const fee = Number(order.serviceFee || 0);
    if(order.paymentStatus!=="Paid") totalFee+=fee; // only pending fees

    const paymentStatus = order.paymentStatus || "Pending";
    const statusClass = paymentStatus==="Paid" ? "status-paid" : "status-pending";

    div.innerHTML=`
      <div class="buyer-info">
        <p><strong>Buyer:</strong> ${order.buyerName || "N/A"}</p>
        <p><strong>Phone:</strong> ${order.buyerPhone || "N/A"}</p>
      </div>

      <div class="product-box">
        <img src="${imgUrl}">
        <div>
          <p><strong>${product.title || "Unknown Product"}</strong></p>
          <p>Price: Rs ${product.price || "N/A"}</p>
        </div>
      </div>

      <div class="fee-box">
        <p><strong>Payment ID:</strong> ${order.paymentId}</p>
        <p><strong>Payment Status:</strong> ${paymentStatus}</p>
        <p><strong>Service Fee:</strong> Rs ${fee}</p>
      </div>

      <div class="status-badge ${statusClass}">${paymentStatus}</div>
    `;

    container.appendChild(div);
  });

  // Only show bottom bar for Pending
  if(currentFilter==="Paid"){
    bottomBar.style.display="none";
  }else{
    bottomBar.style.display="flex";
    totalFeeHTML.textContent = "Rs " + totalFee;
  }

  // update active button style
  document.querySelectorAll(".filter-bar button").forEach(btn=>btn.classList.remove("filter-active"));
  if(currentFilter==="Pending") document.getElementById("filterPending").classList.add("filter-active");
  if(currentFilter==="Paid") document.getElementById("filterPaid").classList.add("filter-active");
}

// FILTER BUTTON EVENTS
document.getElementById("filterPending").addEventListener("click", ()=>{currentFilter="Pending"; renderOrders();});
document.getElementById("filterPaid").addEventListener("click", ()=>{currentFilter="Paid"; renderOrders();});

// PAY BUTTON
document.getElementById("withdrawBtn").addEventListener("click", ()=>{
  const pendingOrders = deliveredOrders.filter(o=>o.paymentStatus!=="Paid");
  if(pendingOrders.length===0){
    alert("No pending delivered orders to pay.");
    return;
  }
  localStorage.setItem("payOrders", JSON.stringify(pendingOrders));
  window.location.href="payment.html";
});

window.onload = loadOrders;
</script>

</body>
</html>